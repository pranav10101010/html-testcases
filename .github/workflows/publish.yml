name: Convert and Publish Reports

on:
  push:
    branches: [ main ]

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install beautifulsoup4

      - name: Convert HTML to JSON
        run: |
          mkdir -p test-results
          python <<'EOF'
          import json
          from bs4 import BeautifulSoup
          from pathlib import Path

          html_file = Path("full_status.html")
          if not html_file.exists():
              raise FileNotFoundError("full_status.html not found at repo root")

          with open(html_file) as f:
              soup = BeautifulSoup(f, "html.parser")

          results = []
          for row in soup.find_all("tr"):
              cols = [td.get_text(strip=True) for td in row.find_all("td")]
              if not cols:
                  continue
              results.append({
                  "test": cols[0],
                  "status": cols[1] if len(cols) > 1 else "passed"
              })

          with open("test-results/report.json", "w") as f:
              json.dump(results, f, indent=2)
          EOF

      - name: Convert JSON to JUnit XML
        run: |
          python <<'EOF'
          import json

          with open("test-results/report.json") as f:
              results = json.load(f)

          with open("test-results/report.xml", "w") as f:
              f.write('<testsuites>\n')
              f.write('  <testsuite name="HTML Report">\n')

              for test in results:
                  name = test["test"]
                  status = test["status"].lower()
                  if status == "failed":
                      f.write(f'    <testcase name="{name}"><failure message="Failed"/></testcase>\n')
                  else:
                      f.write(f'    <testcase name="{name}"/>\n')

              f.write('  </testsuite>\n')
              f.write('</testsuites>\n')
          EOF

      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: ${{ !cancelled() }}
        with:
          files: |
            test-results/**/*.xml
